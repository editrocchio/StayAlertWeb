<!DOCTYPE html>
<html lang="en">

<head>
  <title>Stay Alert</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.css">
  <link rel="stylesheet" type="text/css" href="CSS/index.css">
  <!-- Firebase App is always required and must be first -->
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase-app.js"></script>
  <!-- Add additional services that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
  <script>
    // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAu57uZOerao8kNtGDqXPtyk_7UynVM9P0",
        authDomain: "stayalert-85212.firebaseapp.com",
        databaseURL: "https://stayalert-85212.firebaseio.com",
        projectId: "stayalert-85212",
        storageBucket: "stayalert-85212.appspot.com",
        messagingSenderId: "312308869743"
      };
      firebase.initializeApp(config);
    </script>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
</head>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.css">
<style>
</style>
</head>

<body>
  <div class="ui inverted menu">
    <div class="header item">
      Stay Alert
    </div>
    <a class="item active" href="index.html">
      Map
    </a>
    <a class="item" href="database.html">
      Database
    </a>
    <a class="item" href="ReportACrime.html">
      Report a Crime
    </a>
    <a class="item" href="faq.html">
      FAQ
    </a>
  </div>

  <div id="floating-panel">
    <button id="heatmap" onclick="toggleHeatmap()">Toggle Heatmap</button>
  </div>

  <div id="map"></div>

  <div id="filter">
    <h1 class="ui header">
      <p>Filter Map </p>
    </h1>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Break and Enter Commercial">
        <label>
          <p>Break and Enter (Commercial)</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Break and Enter Residential/Other">
        <label>
          <p>Break and Enter (Residential)</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Mischief">
        <label>
          <p>Mischief</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Other Theft">
        <label>
          <p>Other Theft</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Theft from Vehicle">
        <label>
          <p>Theft From Vehicle</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Theft of Vehicle">
        <label>
          <p>Theft of Vehicle</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Theft of Bicycle">
        <label>
          <p>Theft of Bicycle</p>
        </label>
      </div>
    </div>
    <div class="outercheck">
      <div class="ui checkbox">
        <input type="checkbox" name="example" checked="" id="Vehicle Collision or Pedestrian Struck (with Injury)">
        <label>
          <p>Vehicle Collision or Pedestrian Struck (injury)</p>
        </label>
      </div>
    </div>
  </div>

  <div class="disclaimer">
    <h1 class="ui header">
      <p>Disclaimer</p>
    </h1>
    <label>
      <p id="disclaimerText">Stay Alert is intended to enhance community awareness of policing activity in Vancouver. Users are cautioned not to rely on the information provided to make decisions about the specific safety level of a specific location or area.<br/><br/> Users should be aware that this tool is designed to provide individuals with a general overview of incidents falling into several crime categories.<br/><br/> The data provided is based upon information contained in the VPD Records Management System. The crime classification and file status may change at any time based on the dynamic nature of police investigations. </p>
    </label>
  </div>

  <div id="twitterDiv">
    <a class="twitter-timeline" data-width="100%" data-height="500" data-theme="dark" data-link-color="#F5F8FA" data-chrome="nofooter" href="https://twitter.com/VancouverPD?ref_src=twsrc%5Etfw">Tweets by VancouverPD</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>

  <script>
    // Initialize Cloud Firestore through Firebase
    var db = firebase.firestore();

    // Disable deprecated features
    db.settings({
      timestampsInSnapshots: true
    });

    var docRef = db.collection("new_data").doc("neighbourhoods");
  </script>

  <script>
    var map;
    var locations = [];
    var heatMapCoords = [];
    var markers;
    var markerCluster;
    var crimeObject;
    var dt;
    var infoWin;
    var fromDatabase = [];
    var checkedUnchecked = {"Break and Enter Commercial":true, "Break and Enter Residential/Other":true,
      "Mischief":true, "Other Theft":true, "Theft from Vehicle":true, "Theft of Vehicle":true,
      "Theft of Bicycle":true,"Vehicle Collision or Pedestrian Struck (with Injury)":true};

    function setMarkers(crime, address, month, day, year, time, latitude, longitude) {
      locations.push({
        lat: latitude,
        lng: longitude,
        info: "<h3>Crime:</h3> " + crime + "<h3>Address:</h3> " + address +
          "<h3>Date:</h3>" + month + " " + day + " " + year + "<h3>Time:</h3>" +
          time
      });
    }

    /*When the map gets initialized get the data from Firestore and put the
    individual data in a global variable. Also set up the initial cluster
    markers and heat map.*/
    function initMap() {
      //Set fromDatabase to any sessionStorage.
      zoomFromDatabase();

      docRef.get().then(function(doc) {
        var data;

        if (doc.exists) {
          data = doc.data();
          dt = data[Object.keys(data)[1]];

          /*if fromDatabase is null then it didn't come from db page so zoom normally.
          Otherwise loop through the crimeObjects and find the matching one,
          then zoom to this spot.*/
          if(fromDatabase == null) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                  lat: 49.2807323,
                  lng: -123.117211
                },
                zoom: 14
              });
           } else {
             for(n=0; n<dt.length; n++) {
               crimeObject = dt[n];
               if(fromDatabase["crime"] == crimeObject["crime"]
                && fromDatabase["address"] == crimeObject["hundredBlockAddress"]
                && fromDatabase["date"] == crimeObject["monthOfCrime"] + " " +
                crimeObject["dayOfCrime"] + " " + crimeObject["yearOfCrime"]
                && fromDatabase["time"] == crimeObject["timeOfCrimeTwentyFourHour"]) {
                  map = new google.maps.Map(document.getElementById('map'), {
                      center: {
                        lat: crimeObject["latitude"],
                        lng: crimeObject["longitude"]
                      },
                      zoom: 20
                    });
                }
             }
           }

          setMCluster();

          for (n=0; n<dt.length; n++) {
            crimeObject = dt[n];
            heatMapCoords.push(new google.maps.LatLng(crimeObject["latitude"], crimeObject["longitude"]));
          }
        }

        $(document).ready(function() {
          $('.menu .item')
            .tab();

          /*If checked set crime as true and reload marker clusters*/
          $('.ui.checkbox').checkbox({
            onChecked: function() {
              var c = $(this).attr('id')
              checkedUnchecked[c] = true;
              markerCluster.clearMarkers();
              setMCluster();
            },

            /*If unchecked set crime as false and reload marker clusters*/
            onUnchecked: function() {
              var c = $(this).attr('id')
              checkedUnchecked[c] = false;
              markerCluster.clearMarkers();
              setMCluster();
            }
          });
        });

      }).catch(function(error) {
        console.log("Error getting document:", error);
      });

      infoWin = new google.maps.InfoWindow();

      heatmap = new google.maps.visualization.HeatmapLayer({
        data: getPoints(),
        map: map
      });
    }

    //Turn on/off heatmap.
    function toggleHeatmap() {
      markerCluster.clearMarkers();
      locations = [];
      if (heatmap.getMap()) {
        heatmap.setMap(null);
        setMCluster();
      } else {
        heatmap.setMap(map);
      }
    }

    /*Loop through the neighbourhood and grab the individual crime object.
      If the crime is active then add it to locations array. Add this to
      clusterMarkers which gets pushed to map. */
    function setMCluster() {
      locations = [];
      for (n = 0; n < dt.length; n++) {
        crimeObject = dt[n];
        if(checkedUnchecked[crimeObject["crime"]] == true) {
          setMarkers(crimeObject["crime"], crimeObject["hundredBlockAddress"],
            crimeObject["monthOfCrime"], crimeObject["dayOfCrime"],
            crimeObject["yearOfCrime"], crimeObject["timeOfCrimeTwentyFourHour"],
            crimeObject["latitude"], crimeObject["longitude"]);
        }

      }

      // Add some markers to the map.
      // Note: The code uses the JavaScript Array.prototype.map() method to
      // create an array of markers based on a given "locations" array.
      // The map() method here has nothing to do with the Google Maps API.
      markers = locations.map(function(location, i) {
        var marker = new google.maps.Marker({
          position: location
        });
        google.maps.event.addListener(marker, 'click', function(evt) {
          infoWin.setContent(location.info);
          infoWin.open(map, marker);
        })
        return marker;
      });

      // Add a marker clusterer to manage the markers.
      markerCluster = new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
        maxZoom: 18
      });
    }

    function getPoints() {
      return heatMapCoords;
    }

    function zoomFromDatabase() {
      fromDatabase = JSON.parse(sessionStorage.getItem('fromDatabase'));
      console.log(fromDatabase);
      sessionStorage.clear();
    }

  </script>
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRGQFuNnBRcxX1-kYEtPNfrMxo6lMjNfk&libraries=visualization&callback=initMap" async defer></script>


</body>

</html>
