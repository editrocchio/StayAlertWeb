<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.css">
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase-app.js"></script>
  <!-- Add additional services that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
  <script>
    // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAu57uZOerao8kNtGDqXPtyk_7UynVM9P0",
        authDomain: "stayalert-85212.firebaseapp.com",
        databaseURL: "https://stayalert-85212.firebaseio.com",
        projectId: "stayalert-85212",
        storageBucket: "stayalert-85212.appspot.com",
        messagingSenderId: "312308869743"
      };
      firebase.initializeApp(config);
    </script>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
  <!--Script to make table sortable-->
  <script src="https://semantic-ui.com/javascript/library/tablesort.js"></script>

  <title>Database</title>
  <style>
    body {
       height: 100%;
       margin: 0 0 0 0;
       padding: 0;
       background-color: #A9AAB0;
      }

      .ui.raised.very.padded.text.container.segment {
        margin-top: -14px;
        margin-left: 10%;
        background-color: #656774;
        height: auto;
      }

      #inner {
        color: white;
        background-color: black;
        height: auto;
      }

      .ui.text.container {
        max-width: 100% !important;

      }

      .clickable {
        cursor: pointer;
      }
    </style>
</head>

<body>
  <div class="ui inverted menu">
    <div class="header item">
      Stay Alert
    </div>
    <a class="item" href="index.html">
      Map
    </a>
    <a class="item active" href="database.html">
      Database
    </a>
    <a class="item" href="ReportACrime.html">
      Report a Crime
    </a>
    <a class="item" href="faq.html">
      FAQ
    </a>
  </div>

  <script>
    // Initialize Cloud Firestore through Firebase
    var db = firebase.firestore();
    var content = [];
    var dt;
    var rowClicked;

    // Disable deprecated features
    db.settings({
      timestampsInSnapshots: true
    });

    var docRef = db.collection("new_data").doc("neighbourhoods");

    /*Get the data from Firestore and put it in neighbourhood's variable.
    Loop through this to get searchable details.*/
      docRef.get().then(function(doc) {
          if (doc.exists) {
            var data = doc.data();
            dt = data[Object.keys(data)[1]];

            for (n = 0; n < dt.length; n++) {
              var crimeObject = dt[n];

              searchableItems(crimeObject["crime"], crimeObject["hundredBlockAddress"],
              crimeObject["monthOfCrime"], crimeObject["dayOfCrime"],
              crimeObject["yearOfCrime"], crimeObject["timeOfCrimeTwentyFourHour"]);
            }

          } else {
              // doc.data() will be undefined in this case
              console.log("No such document!");
          }

          /*Sets up the search bar, sets content as the searchable array and
          allows the title and description to be searchable*/
          $(document).ready(function() {
            $('.ui.search')
              .search({
                source: content,
                searchFields: [
                  'title', 'description'
                ],
                //User clicks a search result, it is returned in result variable.
                onSelect: function(result){
                  sortOnClick(result["title"], parseAddressFromResult(result["description"]));
                }
            });

            //Loop through the results and set up the table here.
            for (n = 0; n < dt.length; n++) {
              var crimeObject = dt[n];
              populateTable(crimeObject["crime"], crimeObject["hundredBlockAddress"],
              crimeObject["monthOfCrime"], crimeObject["dayOfCrime"],
              crimeObject["yearOfCrime"], crimeObject["timeOfCrimeTwentyFourHour"]);
            }

            //Add neighbourhood caption.
            $("#table").append("<caption>Central Business District</caption>");

            //Make table sortable.
            $('table').tablesort();

            addEventListeners();

            //Make each row link to index.html
            $("#tbody").on('click', 'tr', function() {
                window.location = 'index.html';
            });
          });


      }).catch(function(error) {
          console.log("Error getting document:", error);
      });

      //Pushes the details to content array
      function searchableItems(crime, address, month, day, year, time) {
        content.push({
          title: crime,
          description: "<div>Address: " + address + "</div>"
          + "<div>Date: " + month + " " + day + " " + year + "</div>"
          + "<div>Time: " + time + "</div>"
        });
      };

      //Find the table and append a new row with the required info.
      function populateTable(crime, address, month, day, year, time) {
          $(table).find('tbody').append(
            "<tr class='clickable'><td>" + crime + "</td><td>" + address + "</td><td>" + month +
              " " + day + " " + year + "</td><td>" + time + "</td></tr>"
          );

          //Hide the loading div after it begins to poplate.
          $("#load").css("display", "none");
      }

      /*First reset all the display rows in case they were previously hidden.
      Then hide all the rows that don't contain the crime and address.*/
      function sortOnClick(crime, address) {
        var table=document.getElementById('table');

        for(var i=0; i<table.rows.length;i++){
          $(table.rows[i]).css("display", "table-row");
         }

         for(var i=1; i<table.rows.length;i++){
           var c=(table.rows[i].cells[0].innerHTML);
           var a=(table.rows[i].cells[1].innerHTML);
           if(!(c == crime) && !(" " + a == address)) {
            $(table.rows[i]).css("display", "none");
            }
          }
      }

      /*Get the address from the click result. First get the position of the
      second '<' which will always be the end of the address. Return the
      substring starting at 13, which will always be the start of the
      address and ending at the position found in the loop.*/
      function parseAddressFromResult(result) {
        var addressStopPoint = 1;

        while(result.charAt(addressStopPoint) != '<') {
          addressStopPoint++;
        }
        return result.substring(13, addressStopPoint);
      }

      /*Loop through the rows and add an event listener. The function pushes
      the row details to the rowClicked array.*/
      function addEventListeners() {
        var rows = document.getElementsByClassName("clickable");

        for (var i = 0; i < rows.length; i++) {
            rows[i].addEventListener("click", function(){
                rowClicked={
                  crime:$(this).closest("tr").find("td:first-child").text(),
                  address:$(this).closest("tr").find("td:nth-child(2)").text(),
                  date:$(this).closest("tr").find("td:nth-child(3)").text(),
                  time:$(this).closest("tr").find("td:nth-child(4)").text()
                };
              sessionStorage.setItem('fromDatabase', JSON.stringify(rowClicked));
            });
        }
      }

  </script>

  <div class="ui raised very padded text container segment">
    <div class="ui raised very padded text container segment" id="inner">
      <h1>Database</h1>
      <div class="ui inverted divider"></div>

      <!--Search Bar-->
      <div class="ui search">
        <div class="ui icon input">
          <input class="prompt" type="text" placeholder="Enter address, crime...">
          <i class="search icon"></i>
        </div>
        <div class="results"></div>
      </div>

      <!--Table-->
      <table class="ui sortable selectable inverted celled table" id="table">
        <div class="ui active medium text loader" id="load">Loading</div>
        <thead>
          <tr>
            <th>Crime</th>
            <th>Address</th>
            <th>Date</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id='tbody'>

        </tbody>

      </table>

    </div>
  </div>

</body>

</html>
